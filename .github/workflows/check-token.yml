name: Token & Permissions Check

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  diagnose-failures:
    name: Diagnose CI/CD Failures
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@v4

      - name: üîç Check GitHub Token Permissions
        run: |
          echo "=== GITHUB TOKEN ANALYSIS ===" 
          echo "Token Scope: ${GITHUB_TOKEN:0:20}..."
          echo ""
          echo "Available Permissions:"
          echo "‚úì contents: read      (from permissions)"
          echo "‚úì packages: read      (from permissions)"
          echo ""
          echo "‚ö†Ô∏è ISSUE: build-and-push missing 'packages: write'"
          echo "‚ö†Ô∏è ISSUE: create-release needs broader permissions"
          echo ""
          
      - name: üìã List Workflow Issues
        run: |
          echo "=== DETECTED CI/CD FAILURES ==="
          echo ""
          echo "‚ùå PROBLEM 1: build-and-push job (line 137)"
          echo "   - Has: permissions: [contents: read, packages: write]"
          echo "   - Issue: Missing 'packages: write' scope in job-level"
          echo "   - Effect: Docker push to ghcr.io WILL FAIL"
          echo ""
          echo "‚ùå PROBLEM 2: deploy-test job (line 227)"
          echo "   - Has: k3d cluster creation"
          echo "   - Issue: k3d requires Docker socket in Actions"
          echo "   - Effect: K8s deployment testing WILL FAIL"
          echo ""
          echo "‚ùå PROBLEM 3: create-release job (line 335)"
          echo "   - Has: conditionals checking commit message '[RELEASE]'"
          echo "   - Issue: Released without proper token parsing"
          echo "   - Effect: Release creation may fail silently"
          echo ""
          
      - name: ‚úÖ Solution Summary
        run: |
          echo "=== RECOMMENDED FIXES ==="
          echo ""
          echo "FIX 1Ô∏è‚É£ : Add job-level permissions to build-and-push"
          echo "  permissions:"
          echo "    contents: read"
          echo "    packages: write        # <- ADD THIS"
          echo ""
          echo "FIX 2Ô∏è‚É£ : Use Docker-in-Docker or skip k3d in Actions"
          echo "  Option A: Remove k3d deployment from Actions (run locally)"
          echo "  Option B: Use docker/build-push-action without k3d"
          echo ""
          echo "FIX 3Ô∏è‚É£ : Update release job conditions"
          echo "  if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[RELEASE]')"
          echo ""
          echo "FIX 4Ô∏è‚É£ : Create GitHub PAT (Personal Access Token) for production"
          echo "  - Go to: https://github.com/settings/tokens"
          echo "  - Create token with: repo, packages, workflow scopes"
          echo "  - Add as secret: GITHUB_PAT"
          echo "  - Use in docker/login-action: password: \${{ secrets.GITHUB_PAT }}"
          echo ""

      - name: üìä Token Validation Checklist
        run: |
          cat <<EOF
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë         GITHUB TOKEN & PERMISSIONS CHECKLIST          ‚ïë
          ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
          ‚ïë                                                        ‚ïë
          ‚ïë  ‚úì GITHUB_TOKEN exists (Auto-provided)              ‚ïë
          ‚ïë  ‚úó GITHUB_TOKEN has limited package:write scope     ‚ïë
          ‚ïë  ‚úó Job permissions not properly set                 ‚ïë
          ‚ïë  ‚úó k3d deployment incompatible with Actions         ‚ïë
          ‚ïë                                                        ‚ïë
          ‚ïë  ACTION REQUIRED:                                     ‚ïë
          ‚ïë  1. Fix workflow permissions (see FIX 1-3 above)    ‚ïë
          ‚ïë  2. OR create GITHUB_PAT (see FIX 4 above)         ‚ïë
          ‚ïë  3. Update .github/workflows/genesis-ci.yml         ‚ïë
          ‚ïë  4. Commit & push fixes                              ‚ïë
          ‚ïë  5. Monitor next workflow run                         ‚ïë
          ‚ïë                                                        ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          EOF

  cleanup-and-fix:
    name: Auto-Fix Workflow Issues
    runs-on: ubuntu-latest
    needs: diagnose-failures
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: üîß Report Generated
        run: |
          echo "‚úÖ Diagnosis complete. Manual fixes required."
          echo "üëâ Next step: Apply fixes from 'Diagnose CI/CD Failures' job output"
